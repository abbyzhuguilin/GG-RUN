(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"09bb":function(e,t,n){"use strict";var a,r=function(){var e=this,t=e.$createElement;e._self._c},i=[];n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return i})),n.d(t,"a",(function(){return a}))},"4ad6":function(e,t,n){"use strict";(function(e){n("7207"),n("921b");a(n("66fd"));var t=a(n("b539"));function a(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("6e42")["createPage"])},"6a1b":function(e,t,n){},"7d02":function(e,t,n){"use strict";(function(e,a){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=i(n("4795"));function i(e){return e&&e.__esModule?e:{default:e}}function o(e,t,n,a,r,i,o){try{var s=e[i](o),c=s.value}catch(u){return void n(u)}s.done?t(c):Promise.resolve(c).then(a,r)}function s(e){return function(){var t=this,n=arguments;return new Promise((function(a,r){var i=e.apply(t,n);function s(e){o(i,a,r,s,c,"next",e)}function c(e){o(i,a,r,s,c,"throw",e)}s(void 0)}))}}var c={data:function(){return{avatar:"../../static/icon/61.png",msgList:[],chatContent:"",sendHeight:84,myAvatar:"",page:0,hasFlag:!0,qiniuToken:"",sendImg:""}},methods:{sendMsg:function(){var t=this;return s(r.default.mark((function n(){var i,o,s;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t.chatContent){n.next=2;break}return n.abrupt("return");case 2:return n.next=4,t.$fetch(t.$api.sendMsg,{content:t.chatContent,msgType:0},"POST","form");case 4:i=n.sent,e("log",i," at pages\\chat\\chat.vue:74"),o=t.$dayjs(),s=t.$dayjs().fromNow(),0==i.code&&(t.msgList.push({createTime:o,time:s,isAdmin:1,content:t.chatContent,timeFlag:!0,msgType:0}),1!=i.msg&&(e("log",JSON.parse(i.msg)," at pages\\chat\\chat.vue:87"),t.msgList.push(JSON.parse(i.msg))),t.msgList.forEach((function(e,n,a){e.time=t.$dayjs(e.createTime).fromNow(),e.timeFlag=0===n||t.$dayjs(a[n].createTime).valueOf()-t.$dayjs(a[n-1].createTime).valueOf()>6e5})),t.chatContent="",t.$nextTick((function(){a.pageScrollTo({scrollTop:0,duration:0}),a.pageScrollTo({scrollTop:999999,duration:0})})));case 9:case"end":return n.stop()}}),n)})))()},getMsgList:function(){var t=this;return s(r.default.mark((function n(){var i;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t.hasFlag){n.next=2;break}return n.abrupt("return");case 2:return t.page=++t.page,n.next=5,t.$fetch(t.$api.chatMsgList,{pageNum:t.page,pageSize:10},"POST","form");case 5:i=n.sent,e("log",i," at pages\\chat\\chat.vue:117"),1==t.page&&i.rows.reverse(),i.rows.forEach((function(e,n,a){e.time=t.$dayjs(e.createTime).fromNow(),1==t.page?t.msgList.push(e):t.msgList.unshift(e)})),t.msgList.forEach((function(e,n,a){e.timeFlag=0===n||t.$dayjs(a[n].createTime).valueOf()-t.$dayjs(a[n-1].createTime).valueOf()>6e5})),1==t.page&&t.$nextTick((function(){a.pageScrollTo({scrollTop:999999,duration:0})})),t.hasFlag=10*t.page<i.total;case 12:case"end":return n.stop()}}),n)})))()},getSendHeight:function(){var e=this,t=a.createSelectorQuery().select(".button-send-container");t.boundingClientRect((function(t){t.height<=84?e.sendHeight=84:e.sendHeight=t.height+2})).exec()},updateChatFlag:function(){var t=this;return s(r.default.mark((function n(){var a;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,t.$fetch(t.$api.chantReadFlag,{},"POST");case 2:a=n.sent,e("log",a," at pages\\chat\\chat.vue:160");case 4:case"end":return n.stop()}}),n)})))()},chooseImage:function(){var t=this;a.chooseImage({count:1,success:function(n){e("log",n," at pages\\chat\\chat.vue:167"),a.uploadFile({url:t.$api.unloadLocation,filePath:n.tempFilePaths[0],name:"file",header:{token:a.getStorageSync("token")},formData:{token:t.qiniuToken},success:function(e){var n=JSON.parse(e.data);t.sendImg=t.$api.baseLocation+n.hash,a.showLoading({title:"发送中..."}),t.sendImgMsg()},fail:function(e){a.showToast({title:"上传失败",icon:"none"})}})}})},getQiniuToken:function(){var e=this;return s(r.default.mark((function t(){var n;return r.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$fetch(e.$api.getQiniuToken,{},"POST","form");case 2:n=t.sent,e.qiniuToken=n.data.token;case 4:case"end":return t.stop()}}),t)})))()},sendImgMsg:function(){var e=this;return s(r.default.mark((function t(){var n,i,o;return r.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.next=2,e.$fetch(e.$api.sendMsg,{content:e.sendImg,msgType:1},"POST","form");case 2:n=t.sent,i=e.$dayjs(),o=e.$dayjs().fromNow(),0==n.code&&(e.msgList.push({createTime:i,time:o,isAdmin:1,content:e.sendImg,timeFlag:!0,msgType:1}),e.sendImg="",a.pageScrollTo({scrollTop:999999,duration:0}),a.hideLoading());case 6:case"end":return t.stop()}}),t)})))()},previewImage:function(e){var t=[];this.msgList.forEach((function(e){1==e.msgType&&t.push(e.content)}));var n=t.length>1?"default":"none";a.previewImage({urls:t,indicator:n,current:e})}},watch:{chatContent:function(e){this.getSendHeight()}},onLoad:function(e){this.myAvatar=e.avatar,this.getMsgList(),this.updateChatFlag(),this.getQiniuToken()},mounted:function(){this.$nextTick((function(){a.pageScrollTo({scrollTop:999999,duration:0})}))},onPullDownRefresh:function(){this.hasFlag&&this.getMsgList(),a.stopPullDownRefresh()}};t.default=c}).call(this,n("0de9")["default"],n("6e42")["default"])},"7e5a":function(e,t,n){"use strict";var a=n("6a1b"),r=n.n(a);r.a},b539:function(e,t,n){"use strict";n.r(t);var a=n("09bb"),r=n("e4ab");for(var i in r)"default"!==i&&function(e){n.d(t,e,(function(){return r[e]}))}(i);n("7e5a");var o,s=n("f0c5"),c=Object(s["a"])(r["default"],a["b"],a["c"],!1,null,null,null,!1,a["a"],o);t["default"]=c.exports},e4ab:function(e,t,n){"use strict";n.r(t);var a=n("7d02"),r=n.n(a);for(var i in a)"default"!==i&&function(e){n.d(t,e,(function(){return a[e]}))}(i);t["default"]=r.a}},[["4ad6","common/runtime","common/vendor"]]]);